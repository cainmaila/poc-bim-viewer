# POC BIM å»ºç¯‰æª¢è¦–å™¨

åŸºæ–¼ **SvelteKit 2 + Svelte 5 + Three.js** çš„ BIMï¼ˆå»ºç¯‰ä¿¡æ¯æ¨¡å‹ï¼‰äº’å‹•å±•ç¤ºæ‡‰ç”¨ï¼Œæ”¯æ´ glTF æ¨¡å‹è¼‰å…¥ã€å³æ™‚ 3D äº’å‹•èˆ‡ç€è¦½å™¨å¿«å–ã€‚

---

## ï¿½ å¿«é€Ÿé–‹å§‹

### å‰ç½®éœ€æ±‚

ç¢ºä¿å·²å®‰è£ä»¥ä¸‹å·¥å…·ï¼š

```sh
# æª¢æŸ¥ Node.js ç‰ˆæœ¬ï¼ˆéœ€ >= 20.xï¼‰
node -v

# æª¢æŸ¥ pnpm ç‰ˆæœ¬ï¼ˆéœ€ >= 9.xï¼‰
pnpm -v

# å¦‚æœå°šæœªå•Ÿç”¨ pnpmï¼Œè«‹åŸ·è¡Œ
corepack enable pnpm
corepack prepare pnpm@latest --activate
```

### å®‰è£èˆ‡å•Ÿå‹•

```sh
# 1ï¸âƒ£ å®‰è£ä¾è³´
pnpm install

# 2ï¸âƒ£ å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨
pnpm dev

# ç€è¦½å™¨é–‹å•Ÿï¼šhttp://localhost:5173
```

## å°ˆæ¡ˆç°¡ä»‹

é€™æ˜¯ä¸€å€‹ **BIM å»ºç¯‰æª¢è¦–å™¨** æ‡‰ç”¨ï¼Œå°ˆé–€ç”¨æ–¼å±•ç¤ºèˆ‡äº’å‹• glTF/glB æ ¼å¼çš„ 3D å»ºç¯‰æ¨¡å‹ã€‚æ ¸å¿ƒæ¡ç”¨ Three.js å¼•æ“ï¼Œæ”¯æ´è»Œé“æ§åˆ¶ã€æ¨¡å‹å¿«å–èˆ‡æ¼¸é€²å¼åŠ è¼‰ã€‚

### ä¸»è¦ç‰¹è‰²

- ğŸ¢ **BIM æ¨¡å‹æª¢è¦–** â€” é€é Three.js è¼‰å…¥ä¸¦å±•ç¤º glTF/glB å»ºç¯‰æ¨¡å‹
- âš™ï¸ **å³æ™‚äº’å‹•** â€” OrbitControls æ”¯æ´æ—‹è½‰ã€ç¸®æ”¾ã€å¹³ç§»
- ğŸ’¾ **æ™ºèƒ½å¿«å–** â€” IndexedDB å¿«å–å·²è¼‰å…¥æ¨¡å‹ï¼ŒåŠ é€Ÿé‡è¤‡è¨ªå•
- âš¡ **Svelte 5 Runes** â€” ä½¿ç”¨æœ€æ–°éŸ¿æ‡‰å¼èªæ³•
- ğŸ“¦ **éœæ…‹éƒ¨ç½²** â€” é€é `adapter-static` è¼¸å‡ºç´”éœæ…‹æª”æ¡ˆ
- âœ… **TypeScript** â€” å®Œæ•´çš„å‹åˆ¥å®‰å…¨
- ğŸ§ª **æ¸¬è©¦æ•´åˆ** â€” Vitest (å–®å…ƒ) + Playwright (E2E)
- ğŸ”§ **ç¨‹å¼ç¢¼å“è³ª** â€” ESLint + Prettier + Husky é æäº¤æª¢æŸ¥

---

## ç³»çµ±éœ€æ±‚

| å·¥å…·    | ç‰ˆæœ¬éœ€æ±‚ |
| ------- | -------- |
| Node.js | >= 20.x  |
| pnpm    | >= 9.x   |

> âš ï¸ æœ¬å°ˆæ¡ˆ**åƒ…æ”¯æ´ pnpm**ï¼Œè«‹å‹¿ä½¿ç”¨ npm æˆ– yarnã€‚

---

## å¯ç”¨æŒ‡ä»¤

| æŒ‡ä»¤               | èªªæ˜                               |
| ------------------ | ---------------------------------- |
| `pnpm dev`         | å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨                     |
| `pnpm build`       | å»ºæ§‹æ­£å¼ç‰ˆæœ¬                       |
| `pnpm preview`     | é è¦½æ­£å¼ç‰ˆæœ¬                       |
| `pnpm check`       | åŸ·è¡Œ Svelte èˆ‡ TypeScript å‹åˆ¥æª¢æŸ¥ |
| `pnpm check:watch` | ç›£è½æ¨¡å¼å‹åˆ¥æª¢æŸ¥                   |
| `pnpm lint`        | åŸ·è¡Œ ESLint èˆ‡ Prettier æª¢æŸ¥       |
| `pnpm format`      | è‡ªå‹•æ ¼å¼åŒ–ç¨‹å¼ç¢¼                   |
| `pnpm test`        | åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦                       |
| `pnpm test:unit`   | åŸ·è¡Œå–®å…ƒæ¸¬è©¦ (Vitest)              |
| `pnpm test:e2e`    | åŸ·è¡Œç«¯å°ç«¯æ¸¬è©¦ (Playwright)        |

---

## å°ˆæ¡ˆçµæ§‹

```
poc-bim-viewer/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ routes/          # SvelteKit é é¢è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ +layout.svelte
â”‚   â”‚   â””â”€â”€ +page.svelte         # ä¸»é é¢ï¼Œè¼‰å…¥ BIM æª¢è¦–å™¨
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ BIMViewer.svelte      # Three.js BIM æª¢è¦–å…ƒä»¶
â”‚   â”‚   â”‚   â””â”€â”€ LoadingOverlay.svelte # è¼‰å…¥é€²åº¦ç–Šå±¤
â”‚   â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â”‚   â””â”€â”€ modelCache.svelte.ts  # æ¨¡å‹å¿«å–èˆ‡ç‹€æ…‹ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”‚   â”œâ”€â”€ gltfLoader.ts         # glTF æ¨¡å‹è¼‰å…¥å·¥å…·
â”‚   â”‚   â”‚   â””â”€â”€ indexedDBCache.ts     # IndexedDB å¿«å–å¯¦ä½œ
â”‚   â”‚   â”œâ”€â”€ assets/                   # åœ–ç‰‡ã€å­—å‹ç­‰éœæ…‹è³‡æº
â”‚   â”‚   â””â”€â”€ index.ts                  # æ¨¡çµ„åŒ¯å‡ºå…¥å£
â”‚   â”œâ”€â”€ app.html                      # HTML æ¨¡æ¿
â”‚   â””â”€â”€ app.d.ts                      # å…¨åŸŸå‹åˆ¥å®šç¾©
â”œâ”€â”€ static/
â”‚   â”œâ”€â”€ building.glb                  # BIM æ¨¡å‹æª”æ¡ˆ (glTF äºŒé€²åˆ¶)
â”‚   â””â”€â”€ robots.txt
â”œâ”€â”€ e2e/                              # Playwright E2E æ¸¬è©¦
â”œâ”€â”€ svelte.config.js                  # SvelteKit é…ç½®
â”œâ”€â”€ vite.config.ts                    # Vite é…ç½® (å« Vitest)
â”œâ”€â”€ tsconfig.json                     # TypeScript é…ç½®
â”œâ”€â”€ eslint.config.js                  # ESLint é…ç½®
â”œâ”€â”€ playwright.config.ts              # Playwright é…ç½®
â””â”€â”€ package.json                      # ä¾è³´ç®¡ç†
```

---

## ç’°å¢ƒè®Šæ•¸

æœ¬å°ˆæ¡ˆä½¿ç”¨ SvelteKit çš„ç’°å¢ƒè®Šæ•¸æ©Ÿåˆ¶ã€‚å…¬é–‹è®Šæ•¸éœ€ä»¥ `PUBLIC_` å‰ç¶´å‘½åã€‚

| è®Šæ•¸åç¨±           | èªªæ˜                                | å¿…å¡« | é è¨­å€¼ | ç¯„ä¾‹          |
| ------------------ | ----------------------------------- | :--: | ------ | ------------- |
| `PUBLIC_BASE_PATH` | æ‡‰ç”¨ç¨‹å¼çš„å­è·¯å¾‘ (ç”¨æ–¼éæ ¹ç›®éŒ„éƒ¨ç½²) |  å¦  | `""`   | `/bim-viewer` |

### è¨­å®šæ–¹å¼

1. è¤‡è£½ç¯„æœ¬æª”ï¼š

   ```sh
   cp .env.example .env
   ```

2. æˆ–ç›´æ¥å»ºç«‹ `.env` æª”æ¡ˆï¼š
   ```env
   PUBLIC_BASE_PATH=
   ```

### BIM æ¨¡å‹éƒ¨ç½²

- **é–‹ç™¼ç’°å¢ƒ** â€” å°‡ glB/glTF æª”æ¡ˆæ”¾åœ¨ `static/` ç›®éŒ„ä¸‹ï¼ˆä¾‹å¦‚ `static/building.glb`ï¼‰
- **ç”Ÿç”¢ç’°å¢ƒ** â€” å»ºæ§‹ç”¢ç‰©æœƒå°‡ `static/` æª”æ¡ˆè¤‡è£½åˆ° `build/` ç›®éŒ„ï¼Œç„¡é ˆé¡å¤–é…ç½®
- **é ç«¯æ¨¡å‹** â€” è‹¥éœ€å¾é ç«¯ URL è¼‰å…¥ï¼Œåœ¨ `+page.svelte` ä¸­ä¿®æ”¹ `modelUrl` å³å¯

> ğŸ’¡ éœæ…‹éƒ¨ç½²æ™‚ï¼Œæ‡‰å„ªå…ˆä½¿ç”¨æœ¬åœ° glB æª”æ¡ˆä»¥æ¸›å°‘å¤–éƒ¨ä¾è³´ã€‚

---

## BIM æ¨¡å‹èˆ‡å¿«å–

### æ¨¡å‹è¼‰å…¥æµç¨‹

1. **é¦–æ¬¡è¨ªå•** â€” æ‡‰ç”¨å¾ `static/building.glb` ä¸‹è¼‰æ¨¡å‹
2. **é€²åº¦åé¥‹** â€” LoadingOverlay é¡¯ç¤ºä¸‹è¼‰é€²åº¦
3. **å¿«å–å„²å­˜** â€” æ¨¡å‹è¢«å­˜å…¥ç€è¦½å™¨ IndexedDB å¿«å–
4. **é‡è¤‡è¨ªå•** â€” å„ªå…ˆå¾ IndexedDB è®€å–ï¼ŒåŠ é€Ÿé é¢è¼‰å…¥

### æ›¿æ› BIM æ¨¡å‹

```sh
# 1. æº–å‚™ glB æˆ– glTF æª”æ¡ˆ
cp /path/to/your-model.glb static/

# 2. ä¿®æ”¹ src/routes/+page.svelte ä¸­çš„ modelUrl
const modelUrl = `${base}/your-model.glb`
```

### å¿«å–ç®¡ç†

- **è‡ªå‹•å¿«å–** â€” `modelStore` (Svelte store) è‡ªå‹•ç®¡ç†å¿«å–ç”Ÿå‘½é€±æœŸ
- **æ‰‹å‹•æ¸…é™¤** â€” åœ¨ç€è¦½å™¨é–‹ç™¼å·¥å…· (DevTools) > Application > IndexedDB > delete database
- **å¿«å–å¤§å°é™åˆ¶** â€” ä¾ç€è¦½å™¨è¨­å®šï¼Œé€šå¸¸ç‚º 50MB-1GB

---

## é–‹ç™¼è¦ç¯„

### Svelte 5 Runes

æœ¬å°ˆæ¡ˆä½¿ç”¨ Svelte 5 çš„ Runes èªæ³•ï¼š

```svelte
<script lang="ts">
	let count = $state(0)
	let doubled = $derived(count * 2)
</script>
```

### Three.js å ´æ™¯ç®¡ç†

- åœ¨ `BIMViewer.svelte` ä¸­åˆå§‹åŒ– Three.js å ´æ™¯
- ä½¿ç”¨ `OrbitControls` é€²è¡Œç›¸æ©Ÿæ§åˆ¶
- åœ¨ Svelte effect ä¸­ç®¡ç†å ´æ™¯ç”Ÿå‘½é€±æœŸï¼ˆåˆå§‹åŒ–ã€å‹•ç•«è¿´åœˆã€æ¸…ç†è³‡æºï¼‰

### æ¨£å¼æ’°å¯«

ä½¿ç”¨ PostCSS å·¢ç‹€èªæ³•ï¼š

```svelte
<style lang="postcss">
	.viewer-container {
		position: fixed;
		inset: 0;

		& .error-message {
			position: absolute;
		}
	}
</style>
```

### è·¯å¾‘è™•ç†

ç”±æ–¼å¯èƒ½éƒ¨ç½²è‡³å­è·¯å¾‘ï¼Œè«‹ä½¿ç”¨ `$app/paths` è™•ç†é€£çµèˆ‡è³‡æºï¼š

```svelte
<script>
	import { base } from '$app/paths'
</script>

<img src="{base}/building.glb" alt="Model" />
```

---

## æ¸¬è©¦

### å–®å…ƒæ¸¬è©¦ (Vitest)

```sh
pnpm test:unit
```

æ¸¬è©¦æª”æ¡ˆå‘½åè¦å‰‡ï¼š

- Svelte å…ƒä»¶æ¸¬è©¦ï¼š`*.svelte.spec.ts`
- ä¸€èˆ¬å–®å…ƒæ¸¬è©¦ï¼š`*.spec.ts` æˆ– `*.test.ts`

### E2E æ¸¬è©¦ (Playwright)

```sh
pnpm test:e2e
```

æ¸¬è©¦æª”æ¡ˆä½æ–¼ `e2e/` ç›®éŒ„ã€‚

---

## å»ºæ§‹èˆ‡éƒ¨ç½²

### å»ºæ§‹æ­£å¼ç‰ˆæœ¬

```sh
pnpm build
```

å»ºæ§‹ç”¢ç‰©è¼¸å‡ºè‡³ `build/` ç›®éŒ„ï¼Œå¯ç›´æ¥éƒ¨ç½²è‡³ä»»ä½•éœæ…‹æª”æ¡ˆä¼ºæœå™¨ã€‚

### æœ¬æ©Ÿé è¦½

```sh
pnpm preview
```

é è¦½ä¼ºæœå™¨é‹è¡Œæ–¼ http://localhost:4173

### éƒ¨ç½²æ³¨æ„äº‹é …

- âœ… æœ¬å°ˆæ¡ˆä½¿ç”¨ `adapter-static`ï¼Œåƒ…ç”¢å‡ºéœæ…‹æª”æ¡ˆ
- âŒ ä¸æ”¯æ´ Server-Side Rendering (SSR) æˆ– API Routes
- ğŸŒ æ”¯æ´éƒ¨ç½²è‡³ GitHub Pagesã€Netlifyã€Vercel (éœæ…‹æ¨¡å¼) ç­‰å¹³å°

---

## ç¨‹å¼ç¢¼å“è³ª

æäº¤å‰è«‹ç¢ºä¿ï¼š

```sh
pnpm format   # æ ¼å¼åŒ–ç¨‹å¼ç¢¼
pnpm check    # å‹åˆ¥æª¢æŸ¥
pnpm lint     # Lint æª¢æŸ¥
```

Husky æœƒåœ¨ `git commit` æ™‚è‡ªå‹•åŸ·è¡Œé æäº¤æª¢æŸ¥ã€‚

---

## è²¢ç»æŒ‡å—

1. éµå¾ª [Copilot æŒ‡å¼•](.github/copilot-instructions.md) ä¸­çš„é–‹ç™¼è¦ç¯„
2. ç¢ºä¿æ‰€æœ‰æª¢æŸ¥é€šéå¾Œå†æäº¤ï¼š
   ```sh
   pnpm format   # æ ¼å¼åŒ–ç¨‹å¼ç¢¼
   pnpm check    # å‹åˆ¥æª¢æŸ¥
   pnpm lint     # Lint æª¢æŸ¥
   ```
3. æ’°å¯«æ¸…æ¥šçš„ commit message

---

## æˆæ¬Šèˆ‡è¯çµ¡

æœ¬å°ˆæ¡ˆç‚ºå…§éƒ¨é–‹ç™¼ç”¨ã€‚å¦‚æœ‰å•é¡Œï¼Œè«‹è¯çµ¡é–‹ç™¼åœ˜éšŠã€‚
