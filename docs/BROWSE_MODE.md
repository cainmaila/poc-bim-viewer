# BIM Viewer 瀏覽模式 (Browse Mode)

## 概述

BIM Viewer 提供兩種模式：

1. **編輯模式**（Edit Mode，預設首頁 `/`）- 可編輯節點屬性，調整顯示設定
2. **瀏覽模式**（Browse Mode，路由 `/browse`）- 只能瀏覽，根據編輯後的定義展示 3D 場域

## 模式切換

- **從編輯模式切換到瀏覽模式**：點擊頂部的「切換至瀏覽模式」按鈕
- **從瀏覽模式切換到編輯模式**：點擊頂部的「切換至編輯模式」按鈕

## 節點 Menu 屬性

瀏覽模式根據節點的 `menu` 屬性來控制樹狀結構的顯示方式。在編輯模式的屬性面板中，可以為每個節點設定 `menu` 屬性。

### Menu 屬性值

| 屬性值          | 說明                                       | 範例效果                               |
| --------------- | ------------------------------------------ | -------------------------------------- |
| `未設定` (預設) | 節點正常顯示                               | A→B→C 顯示為 A→B→C                     |
| `root`          | 該節點成為瀏覽模式的根節點，祖先節點被隱藏 | A→**B**→C，B 設為 root，顯示為 B→C     |
| `hide`          | 只隱藏該節點本身，子節點提升到父層級       | A→**B**→C→D，B 設為 hide，顯示為 A→C→D |
| `disabled`      | 隱藏該節點及其所有子節點                   | A→**B**→C→D，B 設為 disabled，顯示為 A |

### 詳細說明

#### 1. `menu: "root"` - 設為根節點

- **用途**：當您想從某個特定節點開始展示模型時使用
- **效果**：該節點成為樹狀結構的新根，所有祖先節點都不會顯示
- **範例**：
  ```
  原始結構：Scene → Building → Floor1 → Room01
  Floor1 設為 root
  瀏覽模式顯示：Floor1 → Room01
  ```
- **注意**：可以有多個根節點，它們會並列顯示在樹狀視圖的最上層

#### 2. `menu: "hide"` - 隱藏節點（保留子節點）

- **用途**：當您想隱藏中間層級，讓結構更扁平時使用
- **效果**：該節點不顯示，但其子節點會提升到父層級
- **範例**：
  ```
  原始結構：Scene → Container → Group → Mesh1
  Group 設為 hide
  瀏覽模式顯示：Scene → Container → Mesh1
  ```
- **適用場景**：隱藏技術性的容器節點，只展示有意義的物件

#### 3. `menu: "disabled"` - 禁用節點

- **用途**：當您想完全隱藏某個分支時使用
- **效果**：該節點及其所有後代節點都不會顯示
- **範例**：
  ```
  原始結構：Building → Floor1 → Room01 → Furniture
  Floor1 設為 disabled
  瀏覽模式顯示：Building（Floor1 及其下所有節點都不顯示）
  ```
- **適用場景**：隱藏尚未完成的區域、臨時物件或不需要展示的部分

## 瀏覽模式特點

### UI 差異

| 功能         | 編輯模式                     | 瀏覽模式                   |
| ------------ | ---------------------------- | -------------------------- |
| 樹狀視圖     | 完整節點樹，可編輯可見性     | 根據 menu 屬性過濾的節點樹 |
| 屬性面板     | 可編輯（名稱、可見性、menu） | 只讀顯示（美觀的資訊卡片） |
| 拖放載入模型 | ✅ 支援                      | ❌ 不支援                  |
| 節點選擇     | ✅ 可選擇並編輯              | ✅ 可選擇但不可編輯        |
| 3D 控制      | ✅ 完整支援                  | ✅ 完整支援                |

### 瀏覽模式屬性面板

瀏覽模式的屬性面板採用全新設計，提供更優雅的資訊展示：

- **漸層卡片式設計**：使用漸層背景和陰影效果
- **圖示標識**：根據節點類型顯示對應圖示（資料夾或方塊）
- **狀態指示器**：可見性狀態使用彩色徽章和指示燈
- **資訊分層**：清晰展示節點名稱、類型、路徑等資訊
- **提示說明**：底部提示當前為瀏覽模式，需編輯請切換模式

## 使用流程

### 典型工作流程

1. **載入模型**（編輯模式）
   - 在首頁拖放 `.glb` 檔案
   - 等待模型載入完成

2. **編輯節點屬性**（編輯模式）
   - 在左側樹狀視圖中選擇節點
   - 在右側屬性面板中編輯：
     - 修改顯示名稱
     - 調整可見性
     - 設定 menu 屬性（root/hide/disabled）
   - 點擊「修改」按鈕保存

3. **切換到瀏覽模式**
   - 點擊頂部「切換至瀏覽模式」按鈕
   - 查看根據設定過濾後的節點樹
   - 瀏覽 3D 場域

4. **展示與分享**
   - 在瀏覽模式下展示給其他使用者
   - 只顯示必要的節點，隱藏技術細節
   - 提供清晰的導覽體驗

## 實作細節

### 技術架構

- **類型定義**：`src/lib/types/bimSettings.ts`
  - 定義 `MenuMode` 類型（"root" | "disabled" | "hide"）
  - 擴展 `NodeOverrides` 介面加入 `menu` 屬性
  - 擴展 `EnhancedTreeItem` 介面加入 `menu` 屬性

- **過濾邏輯**：`src/lib/utils/browseTreeFilter.ts`
  - `filterTreeForBrowseMode()` 函數實作節點過濾
  - 處理 root、hide、disabled 三種情況
  - 遞迴處理子節點

- **元件**：
  - `BrowseSidebar.svelte` - 瀏覽模式側邊欄
  - `BrowseTreeView.svelte` - 過濾後的樹狀視圖
  - `BrowsePropertyPanel.svelte` - 只讀屬性面板

- **路由**：
  - `/` - 編輯模式（預設首頁）
  - `/browse` - 瀏覽模式

### 資料持久化

- 節點屬性（包括 menu）儲存在 IndexedDB
- 使用 `bimSettingsStore` 管理狀態
- 兩種模式共用相同的資料來源
- 瀏覽模式只讀取，不修改資料

## 最佳實踐

### 設定 Menu 屬性的建議

1. **設定根節點（root）**
   - 用於將焦點放在特定樓層或區域
   - 適合多樓層建築，每層樓設為一個根節點
   - 可以建立多個獨立的視圖

2. **隱藏節點（hide）**
   - 移除不必要的中間層級
   - 讓結構更扁平、更易理解
   - 隱藏技術性容器（如 "Group", "Container"）

3. **禁用分支（disabled）**
   - 隱藏施工中的區域
   - 隱藏臨時或測試用的物件
   - 隱藏不需要向客戶展示的部分

### 效能考量

- 過濾操作在客戶端即時執行
- 使用 Svelte 5 的 `$derived` 確保響應式更新
- 不影響原始模型資料
- 切換模式時無需重新載入模型

## AI 使用指南

當 AI 需要處理 BIM Viewer 相關任務時，請參考以下規則：

### 理解 Menu 屬性

- `menu` 是節點覆寫屬性之一，與 `displayName` 和 `visible` 同級
- 只在瀏覽模式下影響顯示，編輯模式顯示完整結構
- 屬性值：undefined（預設）、"root"、"hide"、"disabled"

### 過濾邏輯

```typescript
// 過濾優先順序
1. 找出所有 menu="root" 的節點（如果有）
2. 從這些根節點（或原始根）開始遍歷
3. 遇到 menu="disabled" → 跳過該節點及所有子節點
4. 遇到 menu="hide" → 跳過該節點，但子節點提升到父層級
5. 其他節點正常顯示
```

### 修改相關程式碼時

- 類型定義在 `src/lib/types/bimSettings.ts`
- 過濾邏輯在 `src/lib/utils/browseTreeFilter.ts`
- 不要修改 `pathGenerator.ts` 的核心邏輯
- 確保 `EnhancedTreeItem` 始終包含 `menu` 欄位

### 測試建議

測試場景應包含：

- 單一根節點
- 多個根節點
- 連續的 hide 節點
- hide + disabled 組合
- 深層巢狀結構

## 常見問題

**Q: 為什麼我設定了 root，但瀏覽模式還是顯示所有節點？**

A: 請確認：

1. 該節點的 menu 屬性確實設為 "root"
2. 已在編輯模式點擊「修改」按鈕保存
3. 切換到瀏覽模式後檢查左側樹狀視圖

**Q: 可以同時設定多個根節點嗎？**

A: 可以。所有設為 root 的節點會並列顯示在樹狀視圖最上層。

**Q: hide 和 disabled 有什麼區別？**

A:

- `hide`: 只隱藏該節點，子節點會提升顯示
- `disabled`: 隱藏該節點及其所有子節點

**Q: 瀏覽模式的設定會影響 3D 場景的實際可見性嗎？**

A: 不會。menu 屬性只影響側邊欄樹狀視圖的顯示，不影響 3D 場景。若要控制 3D 物件可見性，請使用 `visible` 屬性。

**Q: 我可以在瀏覽模式下載入新模型嗎？**

A: 不行。瀏覽模式只能查看已載入的模型。若要載入新模型，請切換回編輯模式。

## 更新日誌

### Version 1.0.0 (2026-01-11)

- ✨ 新增瀏覽模式路由 `/browse`
- ✨ 新增 `menu` 節點屬性（root/hide/disabled）
- ✨ 實作樹狀節點過濾邏輯
- ✨ 設計全新的瀏覽模式屬性面板
- ✨ 新增模式切換按鈕
- 📝 完整文檔說明

## 相關檔案

- `docs/BROWSE_MODE.md` - 本文檔
- `src/lib/types/bimSettings.ts` - 類型定義
- `src/lib/utils/browseTreeFilter.ts` - 過濾邏輯
- `src/lib/components/BrowseSidebar.svelte` - 瀏覽側邊欄
- `src/lib/components/BrowseTreeView.svelte` - 瀏覽樹狀視圖
- `src/lib/components/BrowsePropertyPanel.svelte` - 瀏覽屬性面板
- `src/routes/browse/+page.svelte` - 瀏覽模式頁面
- `src/routes/+page.svelte` - 編輯模式頁面（首頁）
